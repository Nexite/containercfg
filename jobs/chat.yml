job: chat
datacenters: [ srnd ]

tasks:
  chat:
    image: srnd/mattermost

    resources:
      memory: 512

    volumes:
      share:
        - fileshare: mattermost-config
          mountpoint: /mattermost/config
        - fileshare: mattermost-data
          mountpoint: /mattermost/data
        - fileshare: mattermost-plugins
          mountpoint: /mattermost/plugins

    ports:
      http:
        inner: 8000
        lb:
          - domain: chat.srnd.org
            cert: srnd.org
          - domain: chat.codeday.org
            cert: codeday.org

  pushproxy:
    image: jostyee/docker-mattermost-push-proxy
    version: latest
    resources:
      memory: 64

    volumes:
      share:
        - fileshare: mattermost-push-proxy-config
          mountpoint: /config

    ports:
      pushproxy:
        inner: 8066
        outer: 8066

  plugin-trusty:
    image: tjhorner/mattermost-trusty
    version: latest
    resources:
      memory: 64

    vault:
      policies:
        - mattermost-trusty
      env:
        mattermost-trusty:
          COMMAND_TOKEN: command_token
          TRUSTY_TOKEN: trusty_token
          USER_WHITELIST: user_whitelist
